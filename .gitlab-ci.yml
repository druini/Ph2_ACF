# YAML script for CI of Ph2_ACF Software/Middleware
# Author: Emery Nibigira (IPHC-Strasbourg)
#         emery.nibigira@cern.ch

# The pipeline starts when a merge request is created

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID

image: gitlab-registry.cern.ch/cms-iphc/tk_ph2/dockerimageph2acf

stages:
  - compile
  - run
  - check

build:
    stage: compile
    before_script:
        - cat setup.sh | sed -e "s/source/#source/" > ci_setup.sh
        - source ./ci_setup.sh
    script:
        - mkdir -p build; cd build
        - cmake ..
        - make -j4
    artifacts:
        paths: 
            - ci_setup.sh
            - bin/calibrate
        expire_in: 1 week

run_on_2S:
    stage: run
    dependencies:
        - build
    before_script:
        - printf $EOS_ACCOUNT_PASSWORD | kinit $EOS_ACCOUNT_USERNAME
        - xrdcp root://eosuser.cern.ch//eos/user/c/cmstkph2/ci_repo/reference/CMS2S.xml .
    script:
        - source ./ci_setup.sh
        - calibrate -b -f CMS2S.xml -n -o Results_2S/
    artifacts:
        paths: 
            - Results_2S
            - tools
        expire_in: 1 week
    when: manual
    allow_failure: false

check_run:
    stage: check
    dependencies:
        - run_on_2S
    before_script:
        - printf $EOS_ACCOUNT_PASSWORD | kinit $EOS_ACCOUNT_USERNAME
        - xrdcp root://eosuser.cern.ch//eos/user/c/cmstkph2/ci_repo/reference/PedestalEqualizationResults.root PedestalEqualizationReference.root
    script:
        - cp Results_2S/*/PedestalEqualizationResults.root .
        - python /home/plot.py PedestalEqualizationResults.root PedestalEqualizationReference.root "Detector/Board_0/OpticalGroup_0/Module_0/D_B(0)_O(0)_ModuleNoiseDistribution_Module(0)" output/2S
        - python /home/report.py Report_2S.tex output/2S
    artifacts:
        paths: 
            - Report_2S.pdf
        expire_in: 1 week
    allow_failure: true