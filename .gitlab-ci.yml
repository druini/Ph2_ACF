## YAML script for CI of Ph2_ACF Software/Middleware
## Author: Emery Nibigira (IPHC-Strasbourg)
##         emery.nibigira@cern.ch

## The pipeline starts when a merge request is created

#workflow:
#  rules:
#    - if: $CI_MERGE_REQUEST_ID

image: gitlab-registry.cern.ch/cms-iphc/tk_ph2/dockerimageph2acf

stages:
  - compile
  - run
  - check

build:
  stage: compile
  before_script:
    - cat setup.sh | sed -e "s/source/#source/" > ci_setup.sh
    - source ./ci_setup.sh
  script:
    - mkdir -p build; cd build
    - cmake ..
    - make -j4
  artifacts:
    paths:
      - ci_setup.sh
      - bin/feh_2s_test
      - bin/commission
      - bin/CMSITminiDAQ
    expire_in: 1 week

## IT module
run_on_IT:
  stage: run
  dependencies:
    - build    
  before_script:
    - printf $USER_PASS | base64 -d | kinit $USER_NAME
    - xrdcp -r root://eosuser.cern.ch//eos/user/c/cmstkph2/ci_repo/ci_tools .
  script:
    - source ./ci_setup.sh
    - cd ci_tools
    - CMSITminiDAQ -f CMSIT.xml -c pixelalive
    - CMSITminiDAQ -f CMSIT.xml -c threqu
  after_script:
    - cp ci_tools/Results/Run000000_PixelAlive.root .
    - cp ci_tools/Results/Run000001_ThrEqualization.root .      
  artifacts:
    paths: 
      - Run000000_PixelAlive.root
      - Run000001_ThrEqualization.root
      - ci_tools/plot_canvas.py
    expire_in: 1 week

check_run_on_IT:
  stage: check
  needs: [run_on_IT]
  script:
    - python ci_tools/plot_canvas.py Run000000_PixelAlive.root "Detector/Board_0/OpticalGroup_0/Module_0/Chip_0/D_B(0)_O(0)_M(0)_PixelAlive_Chip(0)" -o plots
    - python ci_tools/plot_canvas.py Run000001_ThrEqualization.root "Detector/Board_0/OpticalGroup_0/Module_0/Chip_0/D_B(0)_O(0)_M(0)_ThrEqualization_Chip(0)" -o plots
  artifacts:
    paths:
      - plots
    expire_in: 1 week

## 2S module
run_on_2S:
  stage: run
  dependencies:
    - build
  before_script:
    - printf $USER_PASS | base64 -d | kinit $USER_NAME
    - xrdcp -r root://eosuser.cern.ch//eos/user/c/cmstkph2/ci_repo/ci_tools .
    #- python ci_tools/status_manager.py 2s_status.txt --get_status  --delay 180 --iter 3
  script:
    #- python ci_tools/status_manager.py 2s_status.txt --set_status 1
    - source ./ci_setup.sh
    - feh_2s_test -f ci_tools/CMS2S.xml -t -m -a --findShorts -b
  after_script:
    #- python ci_tools/status_manager.py 2s_status.txt --set_status 0
    - cp Results/*/Hybrid.root .
  artifacts:
    paths:
      - Hybrid.root  
      - ci_tools/plot_hist.py
    expire_in: 1 week

check_run_on_2S:
  stage: check
  needs: [run_on_2S]
  script:
    - python ci_tools/plot_hist.py Hybrid.root "Detector/Board_0/OpticalGroup_0/Module_0/D_B(0)_O(0)_ModuleNoiseDistribution_Module(0)" -o plots
  artifacts:
    paths:
      - plots
    expire_in: 1 week
