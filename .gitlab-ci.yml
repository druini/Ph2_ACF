## The pipeline starts when a merge request is created

#workflow:
  #rules:
    #- if: $CI_MERGE_REQUEST_ID

image: gitlab-registry.cern.ch/cms-iphc/tk_ph2/dockerimageph2acf

stages:
  - compile
  - run
  #- check

build:
  stage: compile
    - cat setup.sh | sed -e "s/source/#source/" > ci_setup.sh
    - source ./ci_setup.sh
  script:
    - cmake -S . -B build
    - cmake --build build -j 4
  artifacts:
    paths:
      - ci_setup.sh
      - bin/fpgaconfig
    expire_in: 1 week

## 2S hybrid
run_on_2S_FNAL:
  tags:
    - FNAL
  stage: run
  dependencies:
    - build
  before_script:
    - printf $USER_PASS | base64 -d | kinit $USER_NAME
    - xrdcp -r root://eosuser.cern.ch//eos/user/f/fravera/ci_repo/ci_tools .
    - ping 192.168.0.7 -w 5
  script:
    - source ./ci_setup.sh
    #- feh_2s_test -f ci_tools/D19CDescription_2CBC3_Feynman.xml -t -m -a --findShorts -b
    - fpgaconfig -c ci_tools/D19CDescription_2CBC3_Feynman.xml -l

## 2S hybrid
run_on_2S_STRAS:
  tags:
    - Shared
  stage: run
  dependencies:
    - build
  script:
    - source ./ci_setup.sh
    - fpgaconfig -c settings/D19CDescription_Cic2.xml -l
